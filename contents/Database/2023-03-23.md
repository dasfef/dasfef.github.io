---
layout: default
permalink:  /oracle/3
permalink_name: /posts
title:  "[Oracle] PL/SQL í™œìš© procedure, trigger, ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜"
---


<p style="text-align:right; font-weight:bold;">2023.03.23</p>
<br>
sql ì—ëŠ” pl/sql ì´ë€ê²ƒì´ ìˆë‹¤
procedural language ë€ ê²ƒì¸ë°
ì´ì „ êµìœ¡ì—ëŠ” ë°°ìš°ì§€ ëª»í•œ ê²ƒì´ ë‚˜ì˜¤ë‹ˆ
ë‹¹í™©ìŠ¤ëŸ½ê¸°ë„ í•˜ê³  ìƒˆë¡­ê¸°ë„ í–ˆë‹¤
<br>
<p style="font-size:24px; font-weight:bold"><span style="background-color:#007433; color:#ffd300;">1. PROCEDURE</span></p>
<!-- â€‹<br> -->
êµ¬ë¬¸ë§Œ ë³´ìë©´ ì•„ë˜ì™€ ê°™ë‹¤

```sql
CREATE or REPLACE PROCEDURE INSERTBOOK (
    MYBOOKID in number,
    MYBOOKNAME in varchar2,
    MYPUBLISHER in varchar2,
    MYPRICE in number)
as
begin
    insert into book(bookid, bookname, publisher, price)
    values(mybookid, mybookname, mypublisher, myprice);
end;
/
```

create or replace ë‹¤ìŒ procedure ë¥¼ ë¶™ì´ê³ 
ì¡°ê±´ì— ë§Œì¡±í•˜ëŠ” êµ¬ë¬¸ì„ ì‘ì„±í•´ì£¼ë©´ ë˜ëŠ”ë°
ê·¼ ëª‡ê°œì›”ë™ì•ˆ select * from ~ ë§Œ ì“°ë‹¤ê°€
ì´ëŸ° êµ¬ë¬¸ì„ ë§ë‹¥ëœ¨ë¦¬ë‹ˆ ì¶©ê²©ìœ¼ë¡œ ë‹¤ê°€ì™”ë‹¤

ë‚´ê°€ ì•Œê³  ìˆë˜ sql ì´ ë‹¤ê°€ ì•„ë‹ˆêµ¬ë‚˜ ğŸ˜‚

ìœ„ ë‚´ìš©ì„ ì°¨ë¡€ë¡œ ë¶„ì„í•´ë³´ì

```sql
create or replace procedure INSERTBOOK (                    // procedure êµ¬ë¬¸ ìƒì„±
MYBOOKID in number,                                         // number ë¡œ ëœ MYBOOKID
MYBOOKNAME in varchar2,                                     // varchar2 ë¡œ ëœ MYBOOKNAME
MYPUBLISHER in varchar2,                                    // varchar2 ë¡œ ëœ MYPUBLISHER
MYPRICE in number)                                          // number ë¡œ ëœ MYPRICE
as
begin
    insert into book(bookid, bookname, publisher, price)    // procedure ê°€ ì‹¤í–‰ë˜ë©´ í•´ë‹¹ ì—´ insert
    values(mybookid, mybookname, mypublisher, myprice);     // í•´ë‹¹ ì—´ë“¤ì˜ value
end;
â€‹/
```
ì¦‰ procedure ê°€ ì‹¤í–‰ë˜ë©´
ì„ì˜ë¡œ ë§Œë“¤ì–´ ë‘” procedure ë‚´ì˜ ì—´ë“¤ì—
insert êµ¬ë¬¸ì„ begin í•˜ë¼ëŠ” ê²ƒì´ë‹¤

ì˜ì–´ë¥¼ í•´ì„ë§Œ í•˜ë©´ ì–¼ì¶” ë‚´ìš©ì´ ì´í•´ê°€ ê°„ë‹¤
<br>
procedure ì˜ ì‹¤í–‰ì€ ì•„ë˜ì™€ ê°™ë‹¤

```sql
exec insertbook(1, 'ìŠ¤í¬ì¸ ê³¼í•™', 'ê³¼í•™ì„œì ', 25000);
select * from book;
```
exec ì„ í†µí•´ procedure ì˜ ì´ë¦„ê³¼
í•´ë‹¹ procedure ì— í•„ìš”í•œ value ë¥¼ ë„£ì–´ì£¼ë©´ ë!

select * from ~ ìœ¼ë¡œ í…Œì´ë¸”ì—
ë‚´ê°€ ì›í•˜ëŠ” ê°’ë“¤ì´ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ë³´ì

ì´ëŸ° procedure ëŠ”
select ~ êµ¬ë¬¸ì„ ì“°ì§€ ì•Šì•„ë„
ë°”ë¡œ ê°’ì„ ì¶œë ¥í•´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œë„ ì“¸ ìˆ˜ ìˆë‹¤

```sql
create or replace procedure AVERAGEPRICE(
    AVERAGEVAL out number)
as
begin
    select avg(price) into AVERAGEVAL from book 
    where price is not null;
end;

set serveroutput on;
declare
    AVERAGEVAL NUMBER;
begin
    AVERAGEPRICE(AVERAGEVAL);
    DBMS_OUTPUT.PUT_LINE('ì±…ê°’ í‰ê·  : '||AVERAGEVAL);
end;
â€‹/
```
procedure ë„ ì²˜ìŒë³´ëŠ”ë°
AVERAGEVAL ì˜†ì˜ out ë„ ì²˜ìŒë³¸ë‹¤

ì´ out ì€
ë³´í†µ ìš°ë¦¬ê°€ í…Œì´ë¸”ì„ ë§Œë“¤ ë•Œ
CREATE TABLE IN system ì²˜ëŸ¼
in ì„ ì“°ì§€ë§Œ ìƒëµí•˜ê³  ì“°ê¸°ë„ í•˜ëŠ”ë°
ì—¬ê¸°ì„œì˜ in ì€ ìë£Œì˜ 'ì•ˆ'ì— ë„£ëŠ”ê²ƒì´ë‹¤

ì´í•´ê°€ ê°€ì§€ ì•Šì„ ê²ƒì´ê¸° ë•Œë¬¸ì— 
DBMS_OUTPUT.PUT_LINE êµ¬ë¬¸ê³¼
í•¨ê»˜ ì‚´í´ë³´ì

ìœ„ procedure ë¥¼ ì‹¤í–‰í•´ë³´ê³ 
set serveroutput on; ì„ ê¼­ ì‹¤í–‰í•´ì£¼ì–´ì•¼ í•œë‹¤
ê·¸ë¦¬ê³ 
DBMS_OUTPUT.PUT_LINE ì„ ì‹¤í–‰í•´ë³´ë©´

â€‹<figure style="text-align:center;">
<img class="image" src="../contents/imgs/oracle_3/1.png">
</figure>

ì´ëŸ°ì‹ìœ¼ë¡œ ìš°ë¦¬ê°€ ì§ì ‘ 
select ~ ì–´ì©Œêµ¬ í•´ì„œ í‰ê· ê°’ì„ êµ¬í•´ì£¼ì§€ ì•Šì•„ë„
ë°”ë¡œ í‰ê· ì„ êµ¬í•´ì£¼ëŠ” êµ¬ë¬¸ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆë‹¤

ê·¸ëŸ°ë° ë§Œì•½

```sql
create or replace procedure AVERAGEPRICE(
    AVERAGEVAL out number)
```
ì—¬ê¸°ì„œ out ì´ ì•„ë‹Œ in ì„ ì“´ë‹¤ë©´
ì˜¤ë¥˜ê°€ ìƒê¸°ê¸°ë„ í•˜ì§€ë§Œ
ì˜¤ë¥˜ ì—†ì´ ë„˜ì–´ê°„ë‹¤ í•œë“¤

â€‹<figure style="text-align:center;">
<img class="image" src="../contents/imgs/oracle_3/2.png">
</figure>

ìš” ì—ì„œ ì›í•˜ëŠ” ì±…ê°’ í‰ê· ì—ëŠ”
ê°’ì´ ë“¤ì–´ì˜¤ì§€ ì•ŠëŠ”ë‹¤

ì¦‰, out ì€ ì´ì²˜ëŸ¼ 'ë°–'ìœ¼ë¡œ ì¶œë ¥ì„ ì›í•  ë•Œ,
in ì€ 'ì•ˆ'ì—ì„œ ìë£Œ ì •ë¦¬ë¥¼ ì›í•  ë•Œ ì“´ë‹¤

<span style="color:orange">* in out ì„ ê°™ì´ ì¨ì£¼ë©´ ëª¨ë‘ ê°€ëŠ¥</span>
<br>
<p style="font-size:24px; font-weight:bold"><span style="background-color:#007433; color:#ffd300;">2. CURSOR</span></p>

íŒŒì´ì¬ì—ì„œ DBì— ì ‘ì†í•˜ê³ 
sql ì„ í†µí•´ ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ
ì»¤ì„œë¥¼ ë§ì´ ì ‘í•´ë´¤ë‹¤

conn.cursor
cursor.fetchall()

ë“±ìœ¼ë¡œ ë§ì´ í™œìš©í–ˆë‹¤

ì»¤ì„œëŠ” ìš°ë¦¬ê°€ í‰ì†Œì— ì“°ëŠ” ë§ì²˜ëŸ¼
ê¹œë°•ì´ëŠ” ì»¤ì„œë¥¼ ì—°ìƒí•˜ë©´ ì´í•´ê°€ ì‰½ë‹¤

í˜„ì¬ ì–´ë–¤ íŠœí”Œì— ì»¤ì„œê°€ ìœ„ì¹˜í•´ìˆê³ 
í•´ë‹¹ ì»¤ì„œì— ì–´ë–¤ ëª…ë ¹ì„ ì…ë ¥í•˜ëŠëƒ ì¸ê²ƒê°™ë‹¤

â€‹
```sql
create or replace procedure INTEREST 
as
    MYINTEREST NUMERIC;
    PRICE NUMERIC;
    cursor INTERESTCURSOR is select saleprice from orders;      // ì»¤ì„œì— ì–´ë–¤ sql ì„ ë¶ˆëŸ¬ì¤„ì§€ ì„¤ì •
begin
    myinterest := 0.0;
    open interestcursor;                                        // open cursor
    loop
        fetch interestcursor into price;
        exit when interestcursor%notfound;
        if price >= 30000 then
            myinterest := myinterest + price * 0.1;
        else
            myinterest := myinterest + price * 0.05;
        end if;
    end loop;
    close interestcursor;                                       // close cursor
    DBMS_OUTPUT.PUT_LINE('ì „ì²´ ì´ìµ ê¸ˆì•¡ = '||myinterest);
end;
/

set serveroutput on;
exec interest;
```
<br>
<p style="font-size:24px; font-weight:bold;"><span style="background-color:#007433; color:#ffd300">3. TRIGGER</span></p>

íŠ¸ë¦¬ê±°ëŠ” ì–´ë–¤ êµ¬ë¬¸ì´ ìˆ˜í–‰ ë˜ì—ˆì„ ë•Œ
ë”°ë¼ ê°€ê²Œë˜ëŠ” ìˆ˜í–‰êµ¬ë¬¸ì´ë‹¤

ë¬´ì–¸ê°€ ê±´ë“œë ¸ì„ ë•Œ ë°œë™ë˜ëŠ” ë«ì„ ì—°ìƒí•˜ë©´
ì´í•´ê°€ ì‰¬ìš¸ê²ƒ ê°™ë‹¤

íŠ¸ë¦¬ê±°ì—ëŠ” before ì™€ after ê°€ ìˆëŠ”ë°
after ë¥¼ í†µí•œ ë¡œê·¸ ìë£Œ ê¸°ì… êµ¬ë¬¸ì„ ì‚´í´ë³´ì

```sql
-- trigger ì‹¤ìŠµ ìœ„í•œ í…Œì´ë¸” ìƒì„±
create table book_log (
    BOOKID_1 NUMBER,
    BOOKNAME_1 VARCHAR2(40),
    PUBLISHER_1 VARCHAR2(40),
    PRICE_1 NUMBER);
```

```sql
create or replace trigger AFTERINSERTBOOK                             // íŠ¸ë¦¬ê±° ì„¤ì •
after insert on book for each row                                     // íŠ¸ë¦¬ê±° ë°œë™ ì¡°ê±´
declare
    average number;
begin 
    insert into BOOK_LOG
    values(:new.bookid, :new.bookname, :new.publisher, :new.price);
    DBMS_OUTPUT.PUT_LINE('ì‚½ì… íŠœí”Œì„ BOOK_LOG í…Œì´ë¸”ì— ë°±ì—…');
end;
/

insert into book values(16, 'ìŠ¤í¬ì¸  ê³¼í•™ 1', 'ë¯¸ë””ì–´', 25000);         // íŠ¸ë¦¬ê±° ë°œë™ ì¡°ê±´ ìˆ˜í–‰
select * from book where bookid = '16';                                // íŠ¸ë¦¬ê±° ìˆ˜í–‰ ì—¬ë¶€ í™•ì¸
select * from book_log where bookid_1='16';
```
<br>

<p style="font-size:24px; font-weight:bold;"><span style="background-color:#007433; color:#ffd300;">4. ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜</span></p>

ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ëŠ”
ì—¬ëŠ ì–¸ì–´ë“¤ê³¼ ê±°ì˜ ë¹„ìŠ·í•œë‹¤ê³  ëŠê¼ˆë‹¤

ê·¸ë¦¬ ì–´ë µì§„ ì•Šìœ¼ë‹ˆ
ì•„ë˜ êµ¬ë¬¸ì„ ì‚´í´ë³´ë©´ì„œ ì´í•´í•´ë³´ì
â€‹

```sql
create or replace function fnc_interest(          // ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ ì„¤ì •
    price number) return int                     
is
    myinterest number;
begin
    if price >= 30000 then 
        myinterest := price * 0.1;
    else
        myinterest := price * 0.05;
    end if;
    return myinterest;
end;
/

select custid, orderid, saleprice, fnc_interest(saleprice) interest from orders;
```

pl/sql ì„ í†µí•´
ë‚´ê°€ ëª¨ë¥´ë˜ sqlì˜ ì„¸ê³„ë¡œ ë°œì„ ë‹´ê·¼ê±° ê°™ì•„ ì‹ ê¸°í•˜ê¸°ë„ í•˜ì§€ë§Œ
ì§ì ‘ í•„ìš”í•œì‹ìœ¼ë¡œ ì§œë³´ë ¤ë©´
ì¡°ê¸ˆ ìµìˆ™í•´ì§ˆ í•„ìš”ê°€ ìˆì„ê²ƒ ê°™ë‹¤ ğŸ˜‚